# =============================================================================
# TRADEUL SANDBOX - Entorno aislado para ejecución de código del LLM
# =============================================================================
# Este contenedor está diseñado para ejecutar código Python generado por el LLM
# de forma completamente aislada. NO tiene acceso a red, secrets, ni recursos externos.
#
# Principios de seguridad:
# 1. Sin acceso a red (network_mode: none)
# 2. Filesystem read-only excepto /output
# 3. Usuario sin privilegios (sandbox)
# 4. Sin capabilities adicionales
# 5. Límites de recursos (CPU, RAM, tiempo)
# =============================================================================

FROM python:3.11-slim

LABEL maintainer="TradeUL Team"
LABEL description="Isolated sandbox for LLM code execution"
LABEL version="1.0.0"

# Crear usuario sin privilegios
RUN groupadd -r sandbox && useradd -r -g sandbox sandbox

# Instalar dependencias del sistema necesarias para algunas librerías
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Instalar librerías de análisis de datos
# Versiones fijadas para reproducibilidad
RUN pip install --no-cache-dir \
    pandas==2.1.4 \
    numpy==1.26.2 \
    matplotlib==3.8.2 \
    seaborn==0.13.0 \
    scipy==1.11.4 \
    scikit-learn==1.3.2 \
    pyarrow==14.0.2 \
    ta==0.11.0 \
    python-dateutil==2.8.2 \
    pytz==2023.3 \
    duckdb==0.9.2

# Crear directorios de trabajo con permisos correctos
# /data y /output necesitan ser escribibles por el usuario sandbox
RUN mkdir -p /data /output /home/sandbox \
    && chown -R sandbox:sandbox /data /output /home/sandbox \
    && chmod 777 /data /output

# Directorio de trabajo
WORKDIR /home/sandbox

# Cambiar a usuario sin privilegios
USER sandbox

# Variables de entorno para comportamiento predecible
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV MPLCONFIGDIR=/tmp/matplotlib
ENV HOME=/home/sandbox

# El script de entrada se pasa como argumento
# Ejemplo: docker run sandbox python -c "print('hello')"
ENTRYPOINT ["python"]
CMD ["--version"]

